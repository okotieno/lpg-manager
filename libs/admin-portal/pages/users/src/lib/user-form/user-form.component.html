<form [formGroup]="userForm" (ngSubmit)="onSubmit()">
  <ion-row class="ion-margin">
    <ion-col size="12" sizeMd="6">
      <ion-item lines="none">
        <ion-input
          label="First Name"
          labelPlacement="stacked"
          formControlName="firstName"
          placeholder="Enter first name"
          errorText="First name is required"
          helperText="&nbsp;"
        >
        </ion-input>
      </ion-item>
    </ion-col>
    <ion-col size="12" sizeMd="6">
      <ion-item lines="none">
        <ion-input
          label="Last Name"
          labelPlacement="stacked"
          formControlName="lastName"
          placeholder="Enter last name"
          errorText="Last name is required"
          helperText="&nbsp;"
        >
        </ion-input>
      </ion-item>
    </ion-col>
    <ion-col size="12" sizeMd="6">
      <ion-item lines="none">
        <ion-input
          label="Email"
          labelPlacement="stacked"
          formControlName="email"
          type="email"
          placeholder="Enter email address"
          errorText="Valid email is required"
          helperText="&nbsp;"
        >
        </ion-input>
      </ion-item>
    </ion-col>
    <ion-col size="12" sizeMd="6">
      <ion-item lines="none">
        <ion-input
          label="Phone"
          labelPlacement="stacked"
          formControlName="phone"
          type="tel"
          [maskito]="phoneMask"
          [maskitoElement]="maskPredicate"
          placeholder="Enter phone number"
          helperText="Format: +254 7XX XXX XXX"
          [errorText]="userForm.get('phone')?.errors?.['pattern'] ? 'Invalid phone number format' : ''"
        >
        </ion-input>
      </ion-item>
    </ion-col>
  </ion-row>
  <ion-list formArrayName="roles">
    <ng-template
      [ngTemplateOutlet]="addItem"
      [ngTemplateOutletContext]="{ showLabel: true, showButton: this.rolesList().length < 1 }"
    />
    @for (role of this.rolesList(); track role.id) {
      <ion-item class="ion-margin-start" lines="none" [formGroupName]="$index" @roleAnimation>
        <ion-row style="width: 100%;" class="ion-margin-horizontal">
          <ion-col size="12" sizeMd="3">
            <lpg-searchable-select
              [itemsStore]="roleStore"
              label="Role"
              labelPlacement="stacked"
              formControlName="role"
              placeholder="Select roles"
            ></lpg-searchable-select>
          </ion-col>
          <ion-col size="12" sizeMd="3">
            <lpg-searchable-select
              [itemsStore]="roleStore"
              label="Role"
              labelPlacement="stacked"
              formControlName="role"
              placeholder="Select roles"
            ></lpg-searchable-select>
          </ion-col>
          <ion-col size="12" sizeMd="3">
            <lpg-searchable-select
              [itemsStore]="stationStore"
              label="Station"
              labelPlacement="stacked"
              formControlName="station"
              placeholder="Select station"
            ></lpg-searchable-select>
          </ion-col>
          <ion-col size="12" offsetLg="2" sizeMd="1" class="ion-align-self-end">
            <ion-button fill="clear" color="danger" (click)="removeRole($index)">
              <ion-icon name="trash-can"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-item>
    }
    <ng-template
      [ngTemplateOutlet]="addItem"
      [ngTemplateOutletContext]="{ showLabel: false, showButton: roles.controls.length > 0 }"
    />
  </ion-list>

  <div class="ion-margin-top ion-text-end">
    <ion-button fill="clear" type="button" [routerLink]="['../../users']">
      Cancel
    </ion-button>
    <ion-button type="submit" [disabled]="!userForm.valid">
      {{ isEditing() ? 'Update' : 'Create' }}
    </ion-button>
  </div>
</form>

<ng-template #addItem let-showLabel="showLabel" let-showButton="showButton">
  @if (showLabel || showButton) {
    <ion-list-header>
      <ion-label>
        {{ showLabel ? 'Assigned roles' : '' }}
      </ion-label>
      @if (showButton) {
        <ion-button [disabled]="roles.invalid" class="ion-padding" shape="round" (click)="addRole()" fill="clear" size="small">
          <ion-icon name="grid-2-plus" slot="start"></ion-icon>
          Add role
        </ion-button>
      }
    </ion-list-header>
  }
</ng-template>
